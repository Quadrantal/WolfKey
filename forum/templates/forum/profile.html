{% extends 'forum/base.html' %}

{% block head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'forum/css/post-card.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/profile.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/course-selector.css' %}">

{% endblock %}
{% block body_class %}profile-page{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Profile Header -->
        <div class="col-md-12 mb-4" style="z-index: 3;">
            <div class="card">
                <div class="card-body d-flex align-items-center">
                    <!-- Profile Picture Section -->
                    <div class="profile-header d-flex align-items-center" style="flex: 1;">
                        <div class="position-relative">
                            <img 
                                src="{{ profile_user.userprofile.profile_picture.url }}" 
                                alt="Profile Picture" 
                                class="profile-picture changeablePfp"
                                style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; cursor: pointer;"
                                id="profilePicture"
                            >
                            {% if user == profile_user %}
                            <!-- Hover Text -->
                            <div class="hover-text" id="hoverText" style="display: none;">
                                Click to change
                            </div>
                            {% endif %}
                            <!-- Dropdown Menu -->
                            <div class="dropdown-menu" id="profilePictureMenu">
                                <form action="{% url 'upload_profile_picture' %}" method="post" enctype="multipart/form-data" class="p-2" id="profilePictureForm">
                                    {% csrf_token %}
                                    <label for="profile_picture" class="form-label">Upload New Profile Picture:</label>
                                    <input type="file" name="profile_picture" id="profile_picture" class="form-control mb-2">
                                    <button type="submit" class="btn btn-primary btn-sm" disabled>Upload</button>
                                </form>
                            </div>
                        </div>
                        <!-- Name and Bio Section -->
                        <div class="ms-4">
                            <h2>{{ profile_user.get_full_name }}</h2>
                            <span class="text-muted">Joined: {{ profile_user.date_joined|date:"F j, Y" }}</span>
                            <p>{{ profile_user.userprofile.bio }}</p>
                        </div>
                    </div>
                    
                    <!-- Compare Schedules Button -->
                    {% if can_compare %}
                    <div class="ms-auto">
                        <a href="{% url 'course_comparer' %}" class="btn btn-primary" id="compare-schedules-btn">
                            <i class="bi bi-arrow-left-right" title="Compare schedules"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">Profile</button>
            </li>

            {% if user == profile_user %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">Schedule</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab" aria-controls="preferences" aria-selected="false">Preferences</button>
            </li>
            {% endif %}
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="profileTabsContent">
            <!-- Profile Tab -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-md-4">
                        {% if user == profile_user %}
                        <!-- About Me -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">About Me</h5>
                            </div>
                            <div class="card-body">
                                {% if user == profile_user %}
                                <form method="post" id="bioForm">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <textarea name="bio" id="bio" class="form-control" maxlength="500" rows="4">{{ profile_user.userprofile.bio }}</textarea>
                                        <small class="text-muted">Max 500 characters. Avoid inappropriate language.</small>
                                    </div>
                                    <button type="submit" class="btn btn-primary" disabled>Save Bio</button>
                                </form>
                                {% else %}
                                <p>{{ profile_user.userprofile.bio|default:"No bio provided." }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Stats -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Stats</h5>
                            </div>
                            <div class="card-body">
                                <p><i class="bi bi-star-fill text-warning"></i> Points: {{ profile_user.userprofile.points }}</p>
                                <p><i class="bi bi-file-text"></i> Posts: {{posts_count|default:"0"}}</p>
                                <p><i class="bi bi-chat"></i> Solutions: {{solutions_count|default:"0"}}</p>
                            </div>
                        </div>

                        {% if user == profile_user %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Customize Background</h5>
                            </div>
                            <div class="card-body">
                                <form method="post" id="backgroundForm">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="background_hue" class="form-label">Background Color Hue</label>
                                        <input type="range" name="background_hue" id="background_hue" class="form-range background_hue_slider" min="0" max="360" value="{{ profile_user.userprofile.background_hue }}" oninput="setBackground(this.value)">
                                    </div>
                                    <button type="submit" class="btn btn-primary" disabled>Save Changes</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-8">
                        <!-- Recent Activity -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Recent Activity</h5>
                            </div>
                            <div class="card-body">
                                {% for post in recent_posts %}
                                <div class="mb-3">
                                    <h6><a href="{% url 'post_detail' post.id %}">{{ post.title }}</a></h6>
                                    <small class="text-muted">Posted {{ post.created_at|timesince }} ago</small>
                                </div>
                                {% empty %}
                                <p>No recent activity.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Course Experience Section -->
                        <div class="card mb-4 {% if not experienced_courses %}highlighted-card-red{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center z-10">
                                <h5 class="mb-0">Proficient In</h5>
                                {% if user == profile_user %}
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExperienceModal">
                                    <i class="bi bi-plus"></i> Add Course
                                </button>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="course-list">
                                    {% for course in experienced_courses %}
                                    <div class="course-item d-flex justify-content-between align-items-center mb-2">
                                        <span>{{ course.course.name }}</span>
                                        {% if user == profile_user %}
                                        <form method="post" action="{% url 'remove_experience' course.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <p><b>Please add some courses to improve your experience.</b></p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        {% if user == profile_user %}
                        <!-- Help Needed Section -->
                        <div class="card mb-4 {% if not help_needed_courses %}highlighted-card-red{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Need Help In</h5>
                                {% if user == profile_user %}
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addHelpModal">
                                    <i class="bi bi-plus"></i> Add Course
                                </button>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="course-list">
                                    {% for course in help_needed_courses %}
                                    <div class="course-item d-flex justify-content-between align-items-center mb-2">
                                        <span>{{ course.course.name }}</span>
                                        <form method="post" action="{% url 'remove_help_request' course.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% empty %}
                                    <p><b>Please add some courses to improve your experience.</b></p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <div class="row">
                    <div class="col-md-12">

                        <!-- Block Courses Section -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Fill in your schedule info</h5>
                                {% if user == profile_user %}
                                <button type="button" class="btn btn-info btn-sm magic-btn" id="autoCompleteBtn" data-has-wolfnet="{% if has_wolfnet_password %}true{% else %}false{% endif %}" title="Not connected to WolfNet Account. Add password under preferences tab">
                                    <i class="fas fa-magic"></i> Auto-Complete from WolfNet
                                </button>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <form method="post" action="{% url 'update_courses' %}" id="blockCoursesForm">
                                    {% csrf_token %}
                                    {% include 'forum/partials/schedule_block.html' %}
                                    <div class="row">
                                        <div class="col-md-12 mb-1" style="text-align: center">
                                            <button type="submit" class="btn btn-primary" disabled>Save Courses</button>
                                        </div>                                        
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preferences Tab -->
            <div class="tab-pane fade" id="preferences" role="tabpanel" aria-labelledby="preferences-tab">
                <div class="row">
                    <div class="col-md-16">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Update Personal Information</h5>
                            </div>
                            <div class="card-body">
                                <form method="post" id="personalInfoForm">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="id_first_name" class="form-label">First Name</label>
                                        <input type="text" name="first_name" id="id_first_name" class="form-control" value="{{ request.user.first_name }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_last_name" class="form-label">Last Name</label>
                                        <input type="text" name="last_name" id="id_last_name" class="form-control" value="{{ request.user.last_name }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_personal_email" class="form-label">Personal Email</label>
                                        <input type="email" name="personal_email" id="id_personal_email" class="form-control" value="{{ request.user.personal_email }}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_phone_number" class="form-label">Phone Number</label>
                                        <input type="text" name="phone_number" id="id_phone_number" class="form-control" value="{{ request.user.phone_number }}">
                                    </div>
                                    <button type="submit" class="btn btn-primary" disabled>Save Info</button>
                                </form>
                            </div>
                        </div>
    
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">WolfNet Integration</h5>
                            </div>
                            <div class="card-body">
                                <form method="post" id="wolfnetForm">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="wolfnet_settings">
                                    <div class="mb-3">
                                        <label for="id_wolfnet_password" class="form-label">WolfNet Password</label>
                                        <div style="position:relative;">
                                            <input type="password" 
                                                   name="wolfnet_password" 
                                                   id="id_wolfnet_password" 
                                                   class="form-control" 
                                                   placeholder="Enter your WolfNet password"
                                                   value="{% if request.user.userprofile.wolfnet_password %}Password exists; hidden for security{% endif %}">
                                            <button type="button" id="toggleWolfnetPassword" class="btn btn-outline-secondary" tabindex="-1" aria-label="Show/Hide Password" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            Your WolfNet password will be securely stored and used for:
                                            <ul class="mt-2 mb-0">
                                                <li>Email notifications when assignments are graded</li>
                                                <li>Automatic schedule retrieval and updates</li>
                                            </ul>
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" id="checkWolfnetBtn" class="btn btn-primary magic-btn">Check WolfNet Password</button>
                                        {% if request.user.userprofile.wolfnet_password %}
                                        <button type="button" class="btn btn-outline-danger" onclick="clearWolfNetPassword()">Clear Password</button>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                        </div>
    
                        <div class="card mb-4" style = "overflow: hidden;">
                            <a href="{% url 'password_reset' %}" class="btn btn-secondary" style = "z-index: 2;">Reset Password</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Experience Modal -->
<div class="modal fade" id="addExperienceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Course Experience</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addExperienceForm" method="post" action="{% url 'add_experience' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="experience_course" class="form-label">Select a course you have experience with:</label>
                        <select name="course" id="experience_course" class="form-select" required>
                            <option value="">-- Select a course --</option>
                            {% regroup all_courses by category as courses_by_category %}
                            {% for category in courses_by_category %}
                                <optgroup label="{{ category.grouper }}">
                                    {% for course in category.list %}
                                        <option value="{{ course.id }}">{{ course.name }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Help Modal -->
<div class="modal fade" id="addHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Help Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addHelpForm" method="post" action="{% url 'add_help_request' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="help_course" class="form-label">Select a course you need help with:</label>
                        <select name="course" id="help_course" class="form-select" required>
                            <option value="">-- Select a course --</option>
                            {% regroup all_courses by category as courses_by_category %}
                            {% for category in courses_by_category %}
                                <optgroup label="{{ category.grouper }}">
                                    {% for course in category.list %}
                                        <option value="{{ course.id }}">{{ course.name }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // General function to update the block buttons container
    window.updateBlockButtons = function(blockId, course, experiencedCourses, helpNeededCourses) {
        const buttonsContainer = document.getElementById(`${blockId}_buttons`);
        if (!buttonsContainer) return;
        if (course) {
            if (experiencedCourses.includes(course.id) || helpNeededCourses.includes(course.id)) {
                buttonsContainer.style.display = 'none';
            } else {
                buttonsContainer.style.display = 'flex';
            }
        } else {
            buttonsContainer.style.display = 'none';
        }
    }

    // Handle modal form submissions
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Add Experience form
        const addExperienceForm = document.getElementById('addExperienceForm');
        if (addExperienceForm) {
            addExperienceForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addExperienceModal'));
                        modal.hide();
                        
                        // Reload page to show the new experience
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to add course experience'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred while adding course experience');
                }
            });
        }

        // Handle Add Help Request form
        const addHelpForm = document.getElementById('addHelpForm');
        if (addHelpForm) {
            addHelpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addHelpModal'));
                        modal.hide();
                        
                        // Reload page to show the new help request
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to add help request'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred while adding help request');
                }
            });
        }
    });
</script>
<!-- Auto Complete Courses Handler -->
{% if user == profile_user %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const autoCompleteBtn = document.getElementById('autoCompleteBtn');
        if (autoCompleteBtn) {
            const hasWolfnet = autoCompleteBtn.getAttribute('data-has-wolfnet') === 'true';

            console.log(hasWolfnet);

            autoCompleteBtn.addEventListener('click', async function() {
                const hasWolfnetNow = autoCompleteBtn.getAttribute('data-has-wolfnet') === 'true';
                if (!hasWolfnetNow) {
                    alert('Auto-complete unavailable because you do not have a WolfNet password set. Add it under the Preferences tab and then try again. \n\nIf you just set one, reload the page');
                    return;
                }

                // Disable button and show loading state
                autoCompleteBtn.disabled = true;
                autoCompleteBtn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:0.5em;"><div class="loader"></div><span>Loading...</span></span>';

                try {
                    const response = await fetch('{% url "auto_complete_courses" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update course selectors with the fetched data
                        updateCourseSelectors(data.courses);
                    } else {
                        const errorType = data.error_type || 'general';
                        let errorMessage = data.error || 'Failed to auto-complete courses';

                        if (errorType === 'authentication') {
                            if (data.error === 'wrong_password') {
                                alert('Your WolfNet password appears to be incorrect. Please update it in the Preferences tab and try again.');
                            } else {
                                alert('Authentication failed: ' + errorMessage + '. Please check your WolfNet password in the Preferences tab.');
                            }
                        } else if (errorType === 'page_loading') {
                            alert('WolfNet page failed to load properly. Please try again in a moment.');
                        } else if (errorType === 'page_structure') {
                            alert('Unable to find course information on WolfNet page. The page structure may have changed.');
                        } else if (errorType === 'no_courses') {
                            alert('No courses found in your WolfNet schedule. Make sure you have courses enrolled.');
                        } else {
                            alert('Error: ' + errorMessage);
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred while auto-completing courses');
                } finally {
                    // Restore visual disabled state (button remains clickable)
                    autoCompleteBtn.classList.toggle('disabled', !hasWolfnet);
                    autoCompleteBtn.setAttribute('aria-disabled', (!hasWolfnet).toString());
                    autoCompleteBtn.innerHTML = '<i class="fas fa-magic"></i> Auto-Complete from WolfNet';
                }
            });
        }
    });

    function updateCourseSelectors(courses) {
        const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
        
        blocks.forEach(block => {
            const course = courses[block];
            if (course) {
                // Find the course selector instance for this block
                const blockId = `block_${block}`;
                const selector = window.courseSelectors && window.courseSelectors[blockId];
                
                if (selector) {
                    try {
                        // Clear existing selection and add the new course
                        selector.selectedCourses = [course];
                        selector.updateSelectedCourses();
                        selector.updateFormData();
                        
                        // Also update the buttons visibility using the general function
                        const experiencedCourses = JSON.parse('{{ experienced_courses_json|escapejs }}');
                        const helpNeededCourses = JSON.parse('{{ help_needed_courses_json|escapejs }}');
                        window.updateBlockButtons(blockId, course, experiencedCourses, helpNeededCourses);
                    } catch (error) {
                        console.error(`Error updating selector for block ${block}:`, error);
                    }
                } else {
                    console.warn(`Course selector not found for block ${block}`);
                }
            }
        });
    }

</script>
{% endif %}

{% if user == profile_user %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggleWolfnetPassword');
        const passwordInput = document.getElementById('id_wolfnet_password');
        if (toggleBtn && passwordInput) {
            toggleBtn.addEventListener('click', function () {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
        }
        
        // Handle Check WolfNet Password button
        const checkWolfnetBtn = document.getElementById('checkWolfnetBtn');
        if (checkWolfnetBtn) {
            checkWolfnetBtn.addEventListener('click', async function() {
                const passwordInput = document.getElementById('id_wolfnet_password');
                const password = passwordInput.value.trim();
                
                if (!password) {
                    alert('Please enter your WolfNet password first');
                    return;
                }
                
                // Disable button and show loading state
                checkWolfnetBtn.disabled = true;
                checkWolfnetBtn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:0.5em;"><div class="loader"></div><span>Checking...</span></span>';
                
                try {
                    const response = await fetch('/check-wolfnet-password/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            wolfnet_password: password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const message = data.message || 'WolfNet password verified and saved!';
                        checkWolfnetBtn.innerHTML = '<i class="fas fa-check"></i> Saved Successfully';
                        checkWolfnetBtn.classList.remove('btn-primary');
                        checkWolfnetBtn.classList.add('btn-success');
                        // Reload page so the auto-complete button and other UI reflect the saved password
                        setTimeout(function() { window.location.reload(); }, 600);
                    } else {
                        let errorMessage = 'Invalid WolfNet password';
                        if (data.error_type === 'wrong_password') {
                            errorMessage = 'Invalid WolfNet credentials. Please check your password.';
                        } else if (data.error_type === 'timeout' || data.error_type === 'page_loading') {
                            errorMessage = 'WolfNet connection timeout. Please try again.';
                        } else if (data.error) {
                            errorMessage = data.error;
                        }
                        
                        checkWolfnetBtn.innerHTML = '<i class="fas fa-times"></i> Invalid';
                        checkWolfnetBtn.classList.remove('btn-primary');
                        checkWolfnetBtn.classList.add('btn-danger');
                        alert(errorMessage);
                    }
                } catch (error) {
                    console.error('Error checking WolfNet password:', error);
                    alert('Network error occurred while checking password');
                    checkWolfnetBtn.innerHTML = '<i class="fas fa-times"></i> Error';
                    checkWolfnetBtn.classList.remove('btn-primary');
                    checkWolfnetBtn.classList.add('btn-danger');
                } finally {
                    checkWolfnetBtn.disabled = false;
                }
            });
        }
    });

</script>
{% endif %}

<!-- Compare Schedules Button Handler -->
{% if can_compare %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const compareBtn = document.getElementById('compare-schedules-btn');
        if (compareBtn) {
            compareBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Store the initial users data in sessionStorage
                const initialUsers = {{ initial_users|safe }};
                sessionStorage.setItem('courseComparerInitialUsers', JSON.stringify(initialUsers));
                
                // Navigate to course comparer
                window.location.href = this.href;
            });
        }
    });
</script>
{% endif %}

<!-- Background Color Setting -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hueValue = {{ profile_user.userprofile.background_hue }};
        setBackground(hueValue);
    });
    
</script>

<!-- Profile Picture Upload -->
<script>
    {% if user == profile_user %}
    document.addEventListener('DOMContentLoaded', function () {
        const profilePicture = document.getElementById('profilePicture');
        const profilePictureMenu = document.getElementById('profilePictureMenu');
        const hoverText = document.getElementById('hoverText');

        // Show/hide hover text
        profilePicture.addEventListener('mouseenter', () => {
            hoverText.style.display = 'block';
        });
        profilePicture.addEventListener('mouseleave', () => {
            hoverText.style.display = 'none';
        });

        // Toggle dropdown menu
        profilePicture.addEventListener('click', function (e) {
            e.stopPropagation();  // prevent document click from firing
            const isVisible = profilePictureMenu.style.display === 'block';
            profilePictureMenu.style.display = isVisible ? 'none' : 'block';
        });

        // Prevent clicks inside the menu from closing it
        profilePictureMenu.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Close menu on document click if outside
        document.addEventListener('click', function (e) {
            profilePictureMenu.style.display = 'none';
        });
    });
    {% endif %}
</script>


<!-- Personal Info Form Handling -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const personalInfoForm = document.getElementById('personalInfoForm');
        
        personalInfoForm.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });

        personalInfoForm.addEventListener('submit', (event) => {
            const activeElement = document.activeElement;
            if (activeElement.tagName === 'INPUT' && activeElement.type !== 'submit') {
                event.preventDefault();
            }
        });
    });
</script>

<!-- Form Change Tracking and Alert System -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Track changes across all forms
        let hasUnsavedChanges = false;
        let originalFormData = {};
        
        // Get all forms that should be tracked
        const trackedForms = [
            'personalInfoForm',
            'wolfnetForm',
            'blockCoursesForm',
            'bioForm',
            'backgroundForm'
        ];
        
        // Store original form data and add change listeners
        trackedForms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                // Store original data
                originalFormData[formId] = new FormData(form);
                
                // Add change listeners to all inputs (except course selectors which are handled separately)
                const inputs = form.querySelectorAll('input:not([data-course-selector]), textarea:not([data-course-selector]), select:not([data-course-selector])');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        checkForChanges(form, formId);
                    });
                    input.addEventListener('input', () => {
                        checkForChanges(form, formId);
                    });
                });
                
                // Handle form submission
                form.addEventListener('submit', () => {
                    hasUnsavedChanges = false;
                    // Remove change-detected class and disable submit buttons
                    const submitBtns = form.querySelectorAll('button[type="submit"]');
                    submitBtns.forEach(btn => {
                        btn.classList.remove('change-detected');
                        btn.disabled = true;
                    });
                });
            }
        });
        
        // Function to check for changes in a specific form
        function checkForChanges(form, formId) {
            const currentData = new FormData(form);
            const originalData = originalFormData[formId];
            let hasChanges = false;
            
            // Special handling for file inputs
            const fileInputs = form.querySelectorAll('input[type="file"]');
            fileInputs.forEach(fileInput => {
                if (fileInput.files && fileInput.files.length > 0) {
                    hasChanges = true;
                }
            });
            
            // Compare current data with original (skip file inputs as they're handled above)
            if (!hasChanges) {
                for (let [key, value] of currentData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && input.type !== 'file' && originalData.get(key) !== value) {
                        hasChanges = true;
                        break;
                    }
                }
            }
            
            // Check if any original fields are missing in current data (skip file inputs)
            if (!hasChanges) {
                for (let [key, value] of originalData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && input.type !== 'file' && currentData.get(key) !== value) {
                        hasChanges = true;
                        break;
                    }
                }
            }
            
            // Update submit button styling and enabled state
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                if (hasChanges) {
                    submitBtn.classList.add('change-detected');
                    submitBtn.disabled = false;
                    hasUnsavedChanges = true;
                } else {
                    submitBtn.classList.remove('change-detected');
                    submitBtn.disabled = true;
                    checkAllFormsForChanges();
                }
            }
        }
        
        // Function to check if any form has unsaved changes
        function checkAllFormsForChanges() {
            hasUnsavedChanges = false;
            trackedForms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn && submitBtn.classList.contains('change-detected')) {
                        hasUnsavedChanges = true;
                    }
                }
            });
        }
        
        // Expose function to update unsaved changes state from course selectors
        window.updateUnsavedChanges = function(hasChanges) {
            if (hasChanges) {
                hasUnsavedChanges = true;
            } else {
                checkAllFormsForChanges();
            }
        };
        
        // Warn user before leaving page with unsaved changes
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                const message = 'You have unsaved changes. Are you sure you want to leave?';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
        
        // Handle internal navigation (like tab switching)
        document.querySelectorAll('a[href], .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                if (hasUnsavedChanges) {
                    // Always prevent default first
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (this.classList.contains('nav-link')) {
                        const confirmLeave = confirm('You have unsaved changes. Are you sure you want to switch tabs?');
                        if (confirmLeave) {
                            hasUnsavedChanges = false;
                            const tab = new bootstrap.Tab(this);
                            tab.show();
                        }
                    } else {
                        const confirmLeave = confirm('You have unsaved changes. Are you sure you want to leave this page?');
                        if (confirmLeave) {
                            hasUnsavedChanges = false;
                            window.location.href = this.href;
                        }
                    }
                }
            });
        });
    });
</script>

<!-- Course Experience/Help Buttons -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const initialCourses = JSON.parse('{{ initial_courses_json|escapejs }}');

        // Handle "Proficient" and "Need Help" buttons
        document.querySelectorAll('.add-experience-btn, .add-help-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const block = this.dataset.block;
                const courseId = initialCourses[`block_${block}`]?.id;
                const isExperienceBtn = this.classList.contains('add-experience-btn');
                
                if (!courseId) return;

                const url = isExperienceBtn 
                    ? '{% url "add_experience" %}' 
                    : '{% url "add_help_request" %}';
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `course=${courseId}`
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.style.display = 'none';
                        document.getElementById(`block_${block}_buttons`).style.display = 'none';
                    } else {
                        alert('Error: ' + (data.message || 'Request failed'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred');
                }
            });
        });
    });
</script>

<!-- Modal Form Submissions -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Experience Modal Form
        const experienceForm = document.getElementById('addExperienceForm');
        if (experienceForm) {
            experienceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(experienceForm);
                
                try {
                    const response = await fetch(experienceForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('addExperienceModal')).hide();
                        location.reload();
                    } else {
                        alert('Error adding experience: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred');
                }
            });
        }

        // Help Modal Form
        const helpForm = document.getElementById('addHelpForm');
        if (helpForm) {
            helpForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(helpForm);
                
                try {
                    const response = await fetch(helpForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('addHelpModal')).hide();
                        location.reload();
                    } else {
                        alert('Error adding help request: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error occurred');
                }
            });
        }
    });
</script>

<!-- Course Selector Initialization -->
<script type="module">
    import { CourseSelector } from '{% static "forum/js/course-selector.js" %}';
    
    document.addEventListener('DOMContentLoaded', () => {
        const initialCourses = JSON.parse('{{ initial_courses_json|escapejs }}');
        const experiencedCourses = JSON.parse('{{ experienced_courses_json|escapejs }}');
        const helpNeededCourses = JSON.parse('{{ help_needed_courses_json|escapejs }}');        
        const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];

        // Store course selectors globally for auto-complete function
        window.courseSelectors = {};
        
        const originalCourseSelections = JSON.parse(JSON.stringify(initialCourses));

        blocks.forEach(block => {
            const blockId = `block_${block}`;
            const course = initialCourses[blockId];

            updateBlockButtons(blockId, course, experiencedCourses, helpNeededCourses);

            const selector = new CourseSelector({
                containerId: `${blockId}_selector`,
                formName: 'blockCoursesForm',
                maxCourses: 1,
                initialSelection: initialCourses[blockId] ? [initialCourses[blockId]] : [],
                block: block,
                onSelectionChange: (selectedCourses) => {
                    const buttonsContainer = document.getElementById(`${blockId}_buttons`);
                    buttonsContainer.style.display = selectedCourses.length > 0 ? 'flex' : 'none';
                    
                    // Check if course selection has changed from original
                    const currentCourse = selectedCourses.length > 0 ? selectedCourses[0] : null;
                    const originalCourse = originalCourseSelections[blockId];
                    
                    let hasChanged = false;
                    if (!currentCourse && !originalCourse) {
                        hasChanged = false;
                    } else if (!currentCourse || !originalCourse) {
                        hasChanged = true;
                    } else {
                        hasChanged = currentCourse.id !== originalCourse.id;
                    }
                    
                    // Update the submit button for the course form
                    const courseForm = document.getElementById('blockCoursesForm');
                    const courseSubmitBtn = courseForm.querySelector('button[type="submit"]');
                    
                    if (hasChanged) {
                        if (courseSubmitBtn) {
                            courseSubmitBtn.classList.add('change-detected');
                            courseSubmitBtn.disabled = false;
                        }
                        // Update global change tracker
                        if (window.updateUnsavedChanges) {
                            window.updateUnsavedChanges(true);
                        }
                    } else {
                        // Check if any other blocks have changes
                        let anyBlockChanged = false;
                        blocks.forEach(otherBlock => {
                            const otherBlockId = `block_${otherBlock}`;
                            const otherSelector = window.courseSelectors[otherBlockId];
                            if (otherSelector) {
                                const otherCurrent = otherSelector.selectedCourses.length > 0 ? otherSelector.selectedCourses[0] : null;
                                const otherOriginal = originalCourseSelections[otherBlockId];
                                
                                if (!otherCurrent && !otherOriginal) {
                                    // No change
                                } else if (!otherCurrent || !otherOriginal) {
                                    anyBlockChanged = true;
                                } else if (otherCurrent.id !== otherOriginal.id) {
                                    anyBlockChanged = true;
                                }
                            }
                        });
                        
                        if (!anyBlockChanged) {
                            if (courseSubmitBtn) {
                                courseSubmitBtn.classList.remove('change-detected');
                                courseSubmitBtn.disabled = true;
                            }
                            if (window.updateUnsavedChanges) {
                                window.updateUnsavedChanges(false);
                            }
                        }
                    }
                }
            });
            
            window.courseSelectors[blockId] = selector;
        });
        
        // Expose function to update unsaved changes state from course selectors
        window.updateUnsavedChanges = function(hasChanges) {
            // This will be called by course selectors to update the global state
            // The main change tracking script will handle the rest
        };
    });
</script>

<script>
function clearWolfNetPassword() {
    if (confirm('Are you sure you want to clear your WolfNet password? This will disable grade notifications and schedule integration.')) {
        const form = document.getElementById('wolfnetForm');
        const passwordInput = document.getElementById('id_wolfnet_password');
        passwordInput.value = '';
        // Create a hidden input to indicate we want to clear the password
        const clearInput = document.createElement('input');
        clearInput.type = 'hidden';
        clearInput.name = 'clear_wolfnet_password';
        clearInput.value = 'true';
        form.appendChild(clearInput);
        form.submit();
    }
}
</script>
{% endblock %}