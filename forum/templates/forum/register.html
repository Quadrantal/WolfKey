{% extends 'forum/base.html' %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'forum/css/course-selector.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/register.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/asset.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="main-container">
    <h1 class="page-title">WolfKey</h1>

    <div class="progress-container">
        <div class="step-item">
            <div class="step-circle active" data-step="1">1</div>
            <div class="step-label active">Personal Info</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="2">2</div>
            <div class="step-label">WolfNet Integration</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="3">3</div>
            <div class="step-label">Course Experience</div>
        </div>
        <div class="step-item">
            <div class="step-circle" data-step="4">4</div>
            <div class="step-label">Complete</div>
        </div>
    </div>

    <div class="card">
        <form id="onboardingForm" method="post">
            {% csrf_token %}
            
            <!-- Step 1: Personal Information -->
            <div class="form-step active" data-step="1">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <p>Let's start with some information</p>
                </div>
                
                <div class="row">
                    <div class="col-6 mb-3">
                        {{ form.first_name }}
                        {% if form.first_name.help_text %}
                            <small class="help-text">{{ form.first_name.help_text }}</small>
                        {% endif %}
                        <div class="error-message" id="error-first_name"></div>
                    </div>
                    <div class="col-6 mb-3">
                        {{ form.last_name }}
                        {% if form.last_name.help_text %}
                            <small class="help-text">{{ form.last_name.help_text }}</small>
                        {% endif %}
                        <div class="error-message" id="error-last_name"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ form.school_email }}
                    {% if form.school_email.help_text %}
                        <small class="help-text">{{ form.school_email.help_text }}</small>
                    {% endif %}
                    <div class="error-message" id="error-school_email"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.personal_email }}
                    {% if form.personal_email.help_text %}
                        <small class="help-text">{{ form.personal_email.help_text |safe }}</small>
                    {% endif %}
                    <div class="error-message" id="error-personal_email"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.phone_number }}
                    {% if form.phone_number.help_text %}
                        <small class="help-text">{{ form.phone_number.help_text | safe}}</small>
                    {% endif %}
                    <div class="error-message" id="error-phone_number"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.password1 }}
                    {% if form.password1.help_text %}
                        <small class="help-text">{{ form.password1.help_text }}</small>
                    {% endif %}
                    <div class="error-message" id="error-password1"></div>
                </div>
                
                <div class="mb-3">
                    {{ form.password2 }}
                    {% if form.password2.help_text %}
                        <small class="help-text">{{ form.password2.help_text }}</small>
                    {% endif %} 
                    <div class="error-message" id="error-password2"></div>
                </div>

                <div class="continue-btn">
                    <button type="button" class="btn btn-primary" id="nextBtn1">Continue <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <!-- Step 2: WolfNet Integration -->
            <div class="form-step" data-step="2">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>WolfNet Integration</h3>
                    <p>Connect your WolfNet account for automatic schedule and grade updates</p>
                </div>
                
                <div class="card mb-4" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="id_wolfnet_password" class="form-label">WolfNet Password</label>
                            <div style="position:relative;">
                                <input type="password" 
                                       name="wolfnet_password" 
                                       id="id_wolfnet_password" 
                                       class="form-control" 
                                       placeholder="Enter your WolfNet password (optional)">
                                <button type="button" id="toggleWolfnetPassword" class="btn btn-outline-secondary" tabindex="-1" aria-label="Show/Hide Password" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-lock text-success"></i> Your password will be <strong>securely encrypted</strong> and used for:
                                <ul class="mt-2 mb-0">
                                    <li>Automatic schedule retrieval and updates</li>
                                    <li>Email notifications when assignments are graded</li>
                                </ul>
                            </small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Optional:</strong> You can skip this step and add your WolfNet password later in your profile settings.
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn1">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" id="skipBtn2">Skip for Now</button>
                        <button type="button" class="btn btn-primary" id="nextBtn2">Continue <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Course Experience -->
            <div class="form-step" data-step="3">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>Course Experience</h3>
                </div>


                <h6 class="mb-0 text-warning"><i class="fas fa-hand-paper"></i> Courses You'd Like Help With</h6>
                <div class="card-body">
                    <p class="small text-muted">Select courses where you'd appreciate help</p>
                    <div id="helpCoursesSelector"></div>
                    <input type="hidden" name="help_courses" id="help_courses_input">
                </div>
            
                <h6 class="mb-0 text-success"><i class="fas fa-star"></i> Courses You're Proficient In</h6>
                <div class="card-body">
                    <p class="small text-muted">Select courses where you excel and could help others</p>
                    <div id="experienceCoursesSelector"></div>
                    <input type="hidden" name="experience_courses" id="experience_courses_input">
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn2">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn3">Continue <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <!-- Step 4: Schedule Review (Only if WolfNet password provided) -->
            <div class="form-step" data-step="4" id="scheduleStep" style="display: none;">
                <div class="user-icon">
                    <div class="icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
                <div class="heading-section">
                    <h3>Schedule Review</h3>
                    <p>Review and modify your automatically retrieved schedule</p>
                </div>

                <!-- Loading state -->
                <div id="scheduleLoading" class="text-center py-5">
                    <div class="loader mb-3"></div>
                    <h5>Retrieving your schedule from WolfNet...</h5>
                    <p class="text-muted">This may take a moment</p>
                </div>

                <!-- Schedule content -->
                <div id="scheduleContent" style="display: none;">
                    <form id="scheduleForm">
                        {% include 'forum/partials/schedule_block.html' %}
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                                <i class="fas fa-save"></i> Save Schedule
                            </button>
                        </div>
                    </form>
                </div>

                <div class="d-flex justify-content-between mt-4" id="scheduleNavigation" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn3">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="finalizeBtn">
                        <i class="fas fa-check"></i> Complete Registration
                    </button>
                </div>
            </div>

            <!-- Final Step: Completion -->
            <div class="form-step" data-step="complete">
                <div class="text-center py-5">
                    <div class="user-icon">
                        <div class="icon" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <h3 class="mb-4 text-success">Welcome to WolfKey! ðŸŽ‰</h3>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-rocket"></i> Enter WolfKey
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% load static %}
<script type="module">
    import { CourseSelector } from '{% static "forum/js/course-selector.js" %}';
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('onboardingForm');
        const steps = document.querySelectorAll('.form-step');
        const stepCircles = document.querySelectorAll('.step-circle');
        const stepLabels = document.querySelectorAll('.step-label');
        
        let currentStep = 1;
        let wolfnetPassword = '';
        let scheduleTask = null;
        let courseSelectors = {};
        let retrievedCourses = null; // Store courses retrieved early

        // Initialize course selectors for step 3
        function initializeCourseSelectors() {
            console.log("Intializing course selectors");
            
            courseSelectors.help = new CourseSelector({
                containerId: 'helpCoursesSelector',
                maxCourses: 5,
                initialSelection: [],
                formName: "onboardingForm"
            });

            courseSelectors.experience = new CourseSelector({
                containerId: 'experienceCoursesSelector',
                maxCourses: 5,
                initialSelection: [],
                formName: "onboardingForm"
            });
        }

        // Initialize schedule selectors for step 4
        function initializeScheduleSelectors() {
            const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
            
            blocks.forEach(block => {
                const blockId = `block_${block}`;
                courseSelectors[blockId] = new CourseSelector({
                    containerId: `${blockId}_selector`,
                    block: block,
                    maxCourses: 1,
                    initialSelection: [],
                    formName: "onboardingForm",
                    onSelectionChange: (courses) => updateBlockButtons(blockId, courses[0] || null, [], [])
                });
            });
            
            // Apply retrieved courses if they exist
            if (retrievedCourses) {
                updateCourseSelectors(retrievedCourses);
            }
        }

        // Update step UI
        function updateSteps() {
            steps.forEach(step => {
                step.classList.remove('active');
                step.style.display = 'none';
            });
            stepCircles.forEach(circle => circle.classList.remove('active'));
            stepLabels.forEach(label => label.classList.remove('active'));
            
            // Show current step
            const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`) || 
                                      document.querySelector(`.form-step[data-step="complete"]`);
            if (currentStepElement) {
                currentStepElement.classList.add('active');
                currentStepElement.style.display = 'block';
            }
            
            // Update progress circles and bar
            const progressContainer = document.querySelector('.progress-container');
            const stepNumber = currentStep === 'complete' ? 4 : currentStep;
            progressContainer.setAttribute('data-progress', stepNumber);
            
            stepCircles.forEach((circle, index) => {
                if (index + 1 <= stepNumber) {
                    circle.classList.add('active');
                    circle.parentElement.querySelector('.step-label').classList.add('active');
                }
            });
        }

        // Validate current step
        function validateStep(step) {
            if (step === 1) {
                const requiredFields = ['first_name', 'last_name', 'school_email', 'password1', 'password2'];
                for (let field of requiredFields) {
                    const input = document.querySelector(`[name="${field}"]`);
                    if (!input || !input.value.trim()) {
                        showError(field, 'This field is required');
                        return false;
                    }
                }
                
                // Validate passwords match
                const password1 = document.querySelector('[name="password1"]').value;
                const password2 = document.querySelector('[name="password2"]').value;
                if (password1 !== password2) {
                    showError('password2', 'Passwords do not match');
                    return false;
                }
            }
            return true;
        }

        // Show validation error
        function showError(fieldName, message) {
            const errorElement = document.getElementById(`error-${fieldName}`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                const input = document.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.classList.add('is-invalid');
                }
            }
        }

        // Clear validation errors
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
        }

        // Start WolfNet course auto-complete
        async function startCourseAutoComplete() {
            if (!wolfnetPassword) return;
            
            try {
                // Create a temporary form to store the password
                const tempData = new FormData();
                tempData.append('wolfnet_password', wolfnetPassword);
                tempData.append('school_email', document.querySelector('[name="school_email"]').value);
                tempData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const response = await fetch('/auto-complete-courses-registration/', {
                    method: 'POST',
                    body: tempData
                });
                
                const result = await response.json();
                
                if (result.success && result.courses) {
                    retrievedCourses = result.courses;
                    // If selectors are already initialized, apply the courses immediately
                    if (courseSelectors['block_1A']) {
                        updateCourseSelectors(retrievedCourses);
                    }
                    // If we're on the schedule step, show content
                    if (currentStep === 4) {
                        showScheduleContent();
                    }
                } else {
                    // Only show error if we're on the schedule step
                    if (currentStep === 4) {
                        showScheduleError(result.error || 'Failed to retrieve courses');
                    }
                }
            } catch (error) {
                console.error('Auto-complete error:', error);
                // Only show error if we're on the schedule step
                if (currentStep === 4) {
                    showScheduleError('Failed to retrieve courses from WolfNet');
                }
            }
        }

        // Update course selectors with retrieved courses
        function updateCourseSelectors(courses) {
            const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];

            console.log("Courses: ", courses);
            
            blocks.forEach(block => {
                const blockId = `block_${block}`;
                const course = courses[block];
                if (course && courseSelectors[blockId]) {
                    courseSelectors[blockId].addCourse(course);
                    updateBlockButtons(blockId, course, [], []);
                }
            });
        }

        // Show schedule content and hide loading
        function showScheduleContent() {
            document.getElementById('scheduleLoading').style.display = 'none';
            document.getElementById('scheduleContent').style.display = 'block';
            document.getElementById('scheduleNavigation').style.display = 'flex';
        }

        // Show schedule error
        function showScheduleError(message) {
            document.getElementById('scheduleLoading').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Could not retrieve schedule:</strong> ${message}
                    <br><br>
                    <button type="button" class="btn btn-outline-primary" onclick="skipScheduleStep()">
                        Continue Without Schedule
                    </button>
                </div>
            `;
        }

        // Skip schedule step
        window.skipScheduleStep = function() {
            currentStep = 'complete';
            updateSteps();
        };

        // Button event handlers
        if (document.getElementById('nextBtn1')) {
            document.getElementById('nextBtn1').addEventListener('click', function() {
                clearErrors();
                if (validateStep(1)) {
                    currentStep = 2;
                    updateSteps();
                }
            });
        }

        if (document.getElementById('nextBtn2')) {
            document.getElementById('nextBtn2').addEventListener('click', function() {
                wolfnetPassword = document.getElementById('id_wolfnet_password').value;
                currentStep = 3;
                updateSteps();
                // Initialize course selectors when reaching step 3
                initializeCourseSelectors();
                // Start course auto-complete early if password is provided
                if (wolfnetPassword) {
                    startCourseAutoComplete();
                }
            });
        }

        if (document.getElementById('skipBtn2')) {
            document.getElementById('skipBtn2').addEventListener('click', function() {
                wolfnetPassword = '';
                currentStep = 3;
                updateSteps();
                // Initialize course selectors when reaching step 3
                initializeCourseSelectors();
            });
        }

        if (document.getElementById('nextBtn3')) {
            document.getElementById('nextBtn3').addEventListener('click', function() {
                if (wolfnetPassword) {
                    // Show schedule step
                    currentStep = 4;
                    document.querySelector('.form-step[data-step="4"]').style.display = 'block';
                    updateSteps();
                    initializeScheduleSelectors();
                    
                    // If courses were already retrieved, show content immediately
                    if (retrievedCourses) {
                        showScheduleContent();
                    } else {
                        // Start auto-complete if not already started (fallback)
                        startCourseAutoComplete();
                    }
                } else {
                    // Skip to completion
                    currentStep = 'complete';
                    updateSteps();
                }
            });
        }

        if (document.getElementById('prevBtn1')) {
            document.getElementById('prevBtn1').addEventListener('click', function() {
                currentStep = 1;
                updateSteps();
            });
        }

        if (document.getElementById('prevBtn2')) {
            document.getElementById('prevBtn2').addEventListener('click', function() {
                currentStep = 2;
                updateSteps();
            });
        }

        if (document.getElementById('prevBtn3')) {
            document.getElementById('prevBtn3').addEventListener('click', function() {
                currentStep = 3;
                updateSteps();
            });
        }

        if (document.getElementById('finalizeBtn')) {
            document.getElementById('finalizeBtn').addEventListener('click', function() {
                currentStep = 'complete';
                updateSteps();
            });
        }

        // Save schedule button
        if (document.getElementById('saveScheduleBtn')) {
            document.getElementById('saveScheduleBtn').addEventListener('click', function() {
                // Here you would save the schedule data
                currentStep = 'complete';
                updateSteps();
            });
        }

        // Password toggle
        if (document.getElementById('toggleWolfnetPassword')) {
            document.getElementById('toggleWolfnetPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('id_wolfnet_password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            });
        }

        // Block buttons update function (similar to profile.html)
        window.updateBlockButtons = function(blockId, course, experiencedCourses, helpNeededCourses) {
            const buttonsContainer = document.getElementById(`${blockId}_buttons`);
            if (!buttonsContainer) return;
            
            if (course) {
                buttonsContainer.style.display = 'block';
            } else {
                buttonsContainer.style.display = 'none';
            }
        };

        // Form submission
        if (form) {
            form.addEventListener('submit', function(e) {
                // Collect all schedule data
                const blocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
                blocks.forEach(block => {
                    const blockId = `block_${block}`;
                    const selector = courseSelectors[blockId];
                    if (selector && selector.getSelectedCourses && selector.getSelectedCourses().length > 0) {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = blockId;
                        hiddenInput.value = selector.getSelectedCourses()[0].id;
                        form.appendChild(hiddenInput);
                    }
                });
                
                console.log('Submitting registration form...');
            });
        }

        // Initialize
        updateSteps();
    });
</script>
{% endblock %}