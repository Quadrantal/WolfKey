{% extends 'forum/base.html' %}

{% block head %}
{% load static %}
    <link rel="stylesheet" href="{% static 'forum/css/schedule.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/course-comparer.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/user-selector.css' %}">
    <link rel="stylesheet" href="{% static 'forum/css/post-card.css' %}">


    <script type="module" src="{% static 'forum/js/user-selector.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- User Management Section -->
    <div class="card mb-4" style="z-index: 2 !important;">
        <div class="card-body text-center">
            <h5 class="card-title mb-3">Comparing users:</h5>
            
            <!-- Selected Users Display -->
            <div id="selected-users" class="d-flex flex-wrap gap-2 mb-3 justify-content-center">
                <!-- Selected users will be dynamically added here -->
            </div>
            
            <!-- Add User Section -->
            <div class="d-flex justify-content-center">
                <div id="user-selector-container" style="max-width: 400px;">
                    <!-- User selector will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Course Comparison Section -->
    <div id="comparison-section" style="display: none;">
        <!-- Course Tables Row -->
        <div class="row">
            <!-- Day 1 Schedule -->
            <div class="col-md-6 mb-4">
                <div class="card mb-2" style = "text-align: center; font-weight: 500;">Day 1</div>
                <div class="schedule-blocks-container">
                    <!-- User Headers Row -->
                    <div class="user-headers-row" id="user-headers-day1">
                        <!-- User headers will be dynamically added here -->
                    </div>
                    <div class="schedule-block" data-block="1A">
                        <div class="block-label">1A</div>
                        <div class="course-row" id="courses-1A">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="1B">
                        <div class="block-label">1B</div>
                        <div class="course-row" id="courses-1B">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="1D">
                        <div class="block-label">1D</div>
                        <div class="course-row" id="courses-1D">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="1E">
                        <div class="block-label">1E</div>
                        <div class="course-row" id="courses-1E">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Day 2 Schedule -->
            <div class="col-md-6 mb-4">
                <div class="card mb-2" style = "text-align: center; font-weight: 500;">Day 2</div>
                <div class="schedule-blocks-container">
                    <!-- User Headers Row -->
                    <div class="user-headers-row" id="user-headers-day2">
                        <!-- User headers will be dynamically added here -->
                    </div>
                    <div class="schedule-block" data-block="2A">
                        <div class="block-label">2A</div>
                        <div class="course-row" id="courses-2A">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="2B">
                        <div class="block-label">2B</div>
                        <div class="course-row" id="courses-2B">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="2C">
                        <div class="block-label">2C</div>
                        <div class="course-row" id="courses-2C">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="2D">
                        <div class="block-label">2D</div>
                        <div class="course-row" id="courses-2D">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="schedule-block" data-block="2E">
                        <div class="block-label">2E</div>
                        <div class="course-row" id="courses-2E">
                            <!-- Course items will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Empty state -->
    <div id="empty-state" class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No users selected</h5>
        <p class="text-muted">Search and add users to compare their course schedules</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if user.is_authenticated %}
<script>
    window.currentUser = {
        id: {{ user.id }},
        username: '{{ user.username }}',
        full_name: '{{ user.get_full_name }}',
        school_email: '{{ user.school_email }}',
        profile_picture_url: '{{user.userprofile.profile_picture.url}}',
    }; 
</script>
{% endif %}

<script type="module">
import { UserSelector } from '{% static "forum/js/user-selector.js" %}';

document.addEventListener('DOMContentLoaded', function() {
    const comparisonSection = document.getElementById('comparison-section');
    const emptyState = document.getElementById('empty-state');
    const selectedUsersContainer = document.getElementById('selected-users');
    
    let selectedUsersData = [];
    let selectedUsers = []; // Track selected users independently from UserSelector
    
    // Check for initial users from sessionStorage (from profile compare button)
    const storedInitialUsers = sessionStorage.getItem('courseComparerInitialUsers');
    let initialUsers = [];
    
    if (storedInitialUsers) {
        try {
            initialUsers = JSON.parse(storedInitialUsers);
            sessionStorage.removeItem('courseComparerInitialUsers'); // Clear after use
        } catch (e) {
            console.error('Error parsing stored initial users:', e);
        }
    }
    
    // Initialize UserSelector
    const userSelector = new UserSelector({
        containerId: 'user-selector-container',
        onUserSelect: function(user) {
            // Add user to our local list if not already selected
            if (!selectedUsers.find(u => u.id === user.id)) {
                selectedUsers.push(user);
                fetchUserSchedule(user);
                updateSelectedUsersDisplay(selectedUsers);
                
                // Update excluded users for UserSelector
                userSelector.updateExcludeUsers(selectedUsers);
            }
        },
        excludeUsers: selectedUsers
    });
    
    // Add initial users (either from sessionStorage or current user)
    if (initialUsers.length > 0) {
        // Use users from profile compare button
        selectedUsers = [...initialUsers];
        selectedUsers.forEach(user => {
            fetchUserSchedule(user);
        });
        updateSelectedUsersDisplay(selectedUsers);
        userSelector.updateExcludeUsers(selectedUsers);
    } else if (window.currentUser) {
        // Default behavior: add current user
        selectedUsers = [window.currentUser];
        fetchUserSchedule(window.currentUser);
        updateSelectedUsersDisplay(selectedUsers);
        userSelector.updateExcludeUsers(selectedUsers);
    }
    
    function fetchUserSchedule(user) {
        fetch(`/api/user-schedule/${user.id}/`)
            .then(response => response.json())
            .then(data => {
                selectedUsersData.push(data);
                updateLayout();
            })
            .catch(error => {
                console.error('Error fetching user schedule:', error);
            });
    }
    
    function updateSelectedUsersDisplay(users) {
        selectedUsersContainer.innerHTML = users.map(user => `
            <span class="badge d-flex align-items-center gap-2 pill-btn btn-outline-secondary">
                <img src="${user.profile_picture_url}" alt="Profile Picture" class="rounded-circle" style="width: 24px; height: 24px; object-fit: cover;">
                ${user.full_name}
                <span class="user-remove-btn remove-btn" 
                        data-user-id="${user.id}"
                        aria-label="Remove ${user.full_name}">&times</span>
            </span>
        `).join('');

        // Add event listeners to remove buttons
        selectedUsersContainer.querySelectorAll('.user-remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const userId = parseInt(btn.dataset.userId);
                removeUserFromComparison(userId);
            });
        });
    }
    
    function removeUserFromComparison(userId) {
        // Remove from selected users array
        selectedUsers = selectedUsers.filter(user => user.id !== userId);
        
        // Remove from selected users data array
        selectedUsersData = selectedUsersData.filter(userData => userData.user_id !== userId);
        
        // Update displays
        updateSelectedUsersDisplay(selectedUsers);
        updateLayout();
        
        // Update excluded users for UserSelector
        userSelector.updateExcludeUsers(selectedUsers);
    }
    
    function updateLayout() {
        if (selectedUsersData.length === 0) {
            comparisonSection.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        comparisonSection.style.display = 'block';
        emptyState.style.display = 'none';
        arrangeCurrentUserFirst();
        // Update user headers
        updateUserHeaders();
        
        // Update course blocks
        updateCourseBlocks();
    }
    
    function updateUserHeaders() {
        const userHeadersDay1 = document.getElementById('user-headers-day1');
        const userHeadersDay2 = document.getElementById('user-headers-day2');
        
        // Clear existing headers
        userHeadersDay1.innerHTML = '';
        userHeadersDay2.innerHTML = '';
        
        // Add block label space to align with course columns
        const blockLabelSpaceDay1 = document.createElement('div');
        blockLabelSpaceDay1.className = 'block-label-space';
        userHeadersDay1.appendChild(blockLabelSpaceDay1);
        
        const blockLabelSpaceDay2 = document.createElement('div');
        blockLabelSpaceDay2.className = 'block-label-space';
        userHeadersDay2.appendChild(blockLabelSpaceDay2);
        
        // Add user headers (append to the right)
        selectedUsersData.forEach((userData, index) => {
            const userHeaderDay1 = document.createElement('div');
            userHeaderDay1.className = 'user-header d-flex flex-column align-items-center gap-1';
            userHeaderDay1.innerHTML = `
                <img src="${userData.profile_picture_url}" alt="${userData.full_name}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                <span style="font-size: 0.8rem;">${userData.full_name}</span>
            `;
            userHeadersDay1.appendChild(userHeaderDay1);
            
            const userHeaderDay2 = document.createElement('div');
            userHeaderDay2.className = 'user-header d-flex flex-column align-items-center gap-1';
            userHeaderDay2.innerHTML = `
                <img src="${userData.profile_picture_url}" alt="${userData.full_name}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                <span style="font-size: 0.8rem;">${userData.full_name}</span>
            `;
            userHeadersDay2.appendChild(userHeaderDay2);
        });
    }
    
    function updateCourseBlocks() {
        const allBlocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
        
        allBlocks.forEach(block => {
            const courseRow = document.getElementById(`courses-${block}`);
            if (courseRow) {
                courseRow.innerHTML = '';
                
                selectedUsersData.forEach((userData, index) => {
                    const courseItem = document.createElement('div');
                    const courseName = document.createElement('div');
                    courseName.className = 'course-name-container'
                    courseItem.className = 'course-item';
                    courseItem.dataset.userId = userData.user_id;
                    courseItem.dataset.block = block;
                    
                    const course = userData.schedule[block];
                    if (course && course.course) {
                        courseName.textContent = course.course;
                        courseItem.dataset.courseName = course.course;
                    } else {
                        courseName.textContent = '-';
                        courseItem.classList.add('empty');
                    }
                    courseItem.appendChild(courseName);
                    
                    // Append to the right
                    courseRow.appendChild(courseItem);
                });
            }
        });
        
        // Add connection lines after all course blocks are rendered
        setTimeout(() => {
            drawConnectionLines();
        }, 100);
    }
    
    function arrangeCurrentUserFirst() {
        if (!window.currentUser) return;
        
        // Find current user in selectedUsersData and move to first position
        const currentUserDataIndex = selectedUsersData.findIndex(userData => userData.user_id === window.currentUser.id);
        if (currentUserDataIndex > 0) {
            const currentUserData = selectedUsersData.splice(currentUserDataIndex, 1)[0];
            selectedUsersData.unshift(currentUserData);
        }
        
        // Also arrange selectedUsers array to match
        const currentUserIndex = selectedUsers.findIndex(user => user.id === window.currentUser.id);
        if (currentUserIndex > 0) {
            const currentUserObj = selectedUsers.splice(currentUserIndex, 1)[0];
            selectedUsers.unshift(currentUserObj);
        }
        
        // Update the badges display to match the new order
        updateSelectedUsersDisplay(selectedUsers);
    }
    
    function drawConnectionLines() {
        // Remove existing connection lines
        document.querySelectorAll('.course-connection-line').forEach(line => line.remove());
        
        if (selectedUsersData.length < 2) return;
        
        const allBlocks = ['1A', '1B', '1D', '1E', '2A', '2B', '2C', '2D', '2E'];
        
        allBlocks.forEach(block => {
            const courseRow = document.getElementById(`courses-${block}`);
            if (!courseRow) return;
            
            const courseItems = Array.from(courseRow.querySelectorAll('.course-item:not(.empty)'));
            
            // Group course items by course name
            const courseGroups = {};
            courseItems.forEach(item => {
                const courseName = item.dataset.courseName;
                if (courseName && courseName !== '-') {
                    if (!courseGroups[courseName]) {
                        courseGroups[courseName] = [];
                    }
                    courseGroups[courseName].push(item);
                }
            });
            
            // Draw lines for courses that appear more than once
            Object.entries(courseGroups).forEach(([courseName, items]) => {
                if (items.length > 1) {
                    // Add matching class to highlight matching courses
                    items.forEach(item => item.classList.add('has-match'));
                    
                    // Draw connection lines between consecutive matching items
                    for (let i = 0; i < items.length - 1; i++) {
                        drawLineBetweenItems(items[i], items[i + 1], courseRow);
                    }
                }
            });
        });
        
        // Add hover effects
        addConnectionLineHoverEffects();
    }
    
    function drawLineBetweenItems(item1, item2, container) {
        const rect1 = item1.getBoundingClientRect();
        const rect2 = item2.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        // Calculate line position and length
        const startX = rect1.right - containerRect.left;
        const endX = rect2.left - containerRect.left;
        const centerY = (rect1.top + rect1.height / 2) - containerRect.top;
        
        // Create connection line
        const line = document.createElement('div');
        line.className = 'course-connection-line';
        line.style.position = 'absolute';
        line.style.left = `${startX}px`;
        line.style.top = `${centerY - 1.5}px`;
        line.style.width = `${endX - startX}px`;
        
        // Add to container
        container.style.position = 'relative';
        container.appendChild(line);
    }
    
    function addConnectionLineHoverEffects() {
        document.querySelectorAll('.course-item.has-match').forEach(item => {
            item.addEventListener('mouseenter', () => {
                const courseName = item.dataset.courseName;
                const block = item.dataset.block;
                
                // Highlight all matching courses in the same block
                document.querySelectorAll(`[data-block="${block}"][data-course-name="${courseName}"]`).forEach(matchingItem => {
                    matchingItem.style.boxShadow = '0px 0px 20px rgba(16, 185, 129, 0.8)';
                });
                
                // Highlight connection lines in the same block
                const courseRow = document.getElementById(`courses-${block}`);
                if (courseRow) {
                    courseRow.querySelectorAll('.course-connection-line').forEach(line => {
                        line.classList.add('line-highlight');
                    });
                }
            });
            
            item.addEventListener('mouseleave', () => {
                const courseName = item.dataset.courseName;
                const block = item.dataset.block;
                
                // Remove highlight from all matching courses in the same block
                document.querySelectorAll(`[data-block="${block}"][data-course-name="${courseName}"]`).forEach(matchingItem => {
                    matchingItem.style.transform = '';
                    matchingItem.style.boxShadow = '';
                });
                
                // Remove highlight from connection lines in the same block
                const courseRow = document.getElementById(`courses-${block}`);
                if (courseRow) {
                    courseRow.querySelectorAll('.course-connection-line').forEach(line => {
                        line.classList.remove('line-highlight');
                    });
                }
            });
        });
    }
    
    // Initialize layout
    updateLayout();
    
    // Redraw connection lines on window resize
    window.addEventListener('resize', () => {
        if (selectedUsersData.length > 1) {
            setTimeout(() => {
                drawConnectionLines();
            }, 100);
        }
    });
});
</script>
{% endblock %}
